package llm

import "strings"

type TaskCategory string

const (
	CategoryNavigation TaskCategory = "navigation"
	CategoryForm       TaskCategory = "form"
	CategoryExtraction TaskCategory = "extraction"
	CategoryPurchase   TaskCategory = "purchase"
	CategoryGeneral    TaskCategory = "general"
)

func DetectTaskCategory(task string) TaskCategory {
	taskLower := strings.ToLower(task)

	navigationKeywords := []string{"открой", "перейди", "найди страницу", "navigate", "go to", "open", "visit"}
	for _, kw := range navigationKeywords {
		if strings.Contains(taskLower, kw) {
			return CategoryNavigation
		}
	}

	formKeywords := []string{"заполни", "введи", "отправь форму", "зарегистрируйся", "войди", "fill", "submit", "login", "register"}
	for _, kw := range formKeywords {
		if strings.Contains(taskLower, kw) {
			return CategoryForm
		}
	}

	extractionKeywords := []string{"найди", "извлеки", "получи информацию", "скопируй", "прочитай", "find", "extract", "get", "read"}
	for _, kw := range extractionKeywords {
		if strings.Contains(taskLower, kw) {
			return CategoryExtraction
		}
	}

	purchaseKeywords := []string{"купи", "оплати", "закажи", "добавь в корзину", "buy", "purchase", "order", "checkout", "cart"}
	for _, kw := range purchaseKeywords {
		if strings.Contains(taskLower, kw) {
			return CategoryPurchase
		}
	}

	return CategoryGeneral
}

func GetSystemPromptForCategory(category TaskCategory) string {
	switch category {
	case CategoryNavigation:
		return `Ты эксперт-агент по веб-навигации. Ты превосходишь в:
- Эффективном поиске и переходе по ссылкам
- Использовании функции поиска для нахождения страниц
- Понимании структуры сайта и навигационных паттернов
- Изящной обработке редиректов и загрузки страниц

Сфокусируйся на скорости и точности при навигации к целевой странице. ВСЕГДА отвечай на русском языке.`

	case CategoryForm:
		return `Ты эксперт-агент по заполнению форм. Ты превосходишь в:
- Определении всех обязательных и опциональных полей формы
- Точном заполнении форм подходящими данными
- Обработке ошибок валидации и повторных попытках с исправлениями
- Распознавании различных типов полей (текст, select, checkbox, radio)
- Отправке форм только когда все обязательные поля заполнены

Будь тщательным и осторожным с данными формы. Валидируй перед отправкой. ВСЕГДА отвечай на русском языке.`

	case CategoryExtraction:
		return `Ты эксперт-агент по извлечению данных. Ты превосходишь в:
- Определении релевантной информации на страницах
- Точном извлечении структурированных данных
- Обработке пагинации и динамического контента
- Распознавании таблиц, списков и других структур данных
- Фильтрации шума и фокусировке на запрошенной информации

Будь точным и всеобъемлющим в извлечении данных. ВСЕГДА отвечай на русском языке.`

	case CategoryPurchase:
		return `Ты эксперт-агент по электронной коммерции. Ты превосходишь в:
- Поиске товаров и сравнении вариантов
- Правильном добавлении товаров в корзину
- Понимании процесса оформления заказа
- Распознавании форм оплаты и доставки

ВАЖНО: Всегда спрашивай подтверждение пользователя перед:
- Добавлением дорогих товаров в корзину
- Переходом к оплате
- Отправкой заказов
- Вводом платежной информации

Безопасность и контроль пользователя - превыше всего в операциях покупки. ВСЕГДА отвечай на русском языке.`

	default:
		return `Ты AI-агент, управляющий веб-браузером. Ты превосходишь в понимании намерений пользователя и эффективном и безопасном выполнении многошаговых задач. ВСЕГДА отвечай на русском языке.`
	}
}

func GetFewShotExamplesForCategory(category TaskCategory) string {
	switch category {
	case CategoryNavigation:
		return `
Пример задачи навигации:
Задача: "Перейди на страницу контактов"
Шаг 1: Ищи меню навигации или ссылки в футере содержащие "Контакты", "Связаться с нами" или похожее
Шаг 2: Кликни на ссылку контактов
Шаг 3: Проверь что ты на странице контактов по заголовку или URL

Пример с поиском:
Задача: "Найди страницу с ценами"
Шаг 1: Ищи "Цены" в меню навигации
Шаг 2: Если не нашел, используй поиск по сайту с запросом "цены"
Шаг 3: Кликни на наиболее релевантный результат`

	case CategoryForm:
		return `
Пример задачи с формой:
Задача: "Заполни контактную форму с именем Иван и email ivan@example.com"
Шаг 1: Определи все поля формы (имя, email, сообщение и т.д.)
Шаг 2: Заполни поле "имя" значением "Иван"
Шаг 3: Заполни поле "email" значением "ivan@example.com"
Шаг 4: Проверь не пропущены ли обязательные поля
Шаг 5: Отправь форму только когда все обязательные поля заполнены`

	case CategoryExtraction:
		return `
Пример задачи извлечения:
Задача: "Получи список возможностей с этой страницы"
Шаг 1: Просканируй страницу на заголовки типа "Возможности", "Что мы предлагаем" и т.д.
Шаг 2: Определи список или секцию содержащую возможности
Шаг 3: Извлеки каждый элемент возможности с его описанием
Шаг 4: Отформатируй результаты четко`

	case CategoryPurchase:
		return `
Пример задачи покупки:
Задача: "Добавь ноутбук дешевле 100000 рублей в корзину"
Шаг 1: Найди "ноутбук"
Шаг 2: Примени фильтр цены "до 100000"
Шаг 3: Просмотри результаты и определи подходящий вариант
Шаг 4: Кликни на товар чтобы посмотреть детали
Шаг 5: Спроси пользователя: "Нашел [Название товара] за [Цена]. Добавить в корзину?"
Шаг 6: Если одобрено, кликни кнопку "Добавить в корзину"`

	default:
		return ""
	}
}

func GetTaskSpecificGuidance(category TaskCategory) string {
	switch category {
	case CategoryNavigation:
		return `
Ключевые соображения:
- Проверяй URL и заголовок страницы чтобы подтвердить успешную навигацию
- Обрабатывай состояния загрузки и жди пока страница полностью загрузится
- Если прямая ссылка не найдена, попробуй функцию поиска
- Будь внимателен к мега-меню и вложенной навигации`

	case CategoryForm:
		return `
Ключевые соображения:
- Всегда определяй ВСЕ поля перед началом заполнения
- Обращай внимание на метки полей, плейсхолдеры и маркеры обязательности (*)
- Обрабатывай выпадающие списки, чекбоксы и радиокнопки соответственно
- Следи за inline сообщениями валидации
- Не отправляй пока все обязательные поля не заполнены корректно`

	case CategoryExtraction:
		return `
Ключевые соображения:
- Прокрути всю страницу чтобы найти всю релевантную информацию
- Обрабатывай контент с пагинацией переходя по страницам
- Распознавай и обрабатывай динамический контент (AJAX загрузка)
- Структурируй извлеченные данные четко и полностью`

	case CategoryPurchase:
		return `
Ключевые соображения:
- ВСЕГДА проверяй детали товара перед добавлением в корзину
- ВСЕГДА спрашивай подтверждение пользователя для финансовых действий
- Никогда не вводи платежную информацию без явного одобрения
- Будь внимателен к общей стоимости включая доставку и налоги
- Распознавай опции "Подписка" vs "Разовая покупка"`

	default:
		return ""
	}
}
